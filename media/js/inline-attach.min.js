/*! inline-attach - v1.3.1 - 2014-06-27 */
(function(e,t){"use strict";function a(){for(var e={},t=arguments.length-1;t>=0;t--){var a=arguments[t];for(var n in a)e[n]=a[n]}return e}t.inlineAttach=function(e,n){function r(e,t){return(e+"\n\n[[D]]"+t).replace(/(\n{2,})\[\[D\]\]/,"\n\n").replace(/^(\n*)/,"")}var o,i=a(e,inlineAttach.defaults),l=n,s="{filename}",d=this;this.uploadFile=function(e){var t=new FormData,a=new XMLHttpRequest,n="png";if(e.name){var r=e.name.match(/\.(.+)$/);r&&(n=r[1])}if(t.append(i.uploadFieldName,e,"image-"+Date.now()+"."+n),"object"==typeof i.extraParams)for(var o in i.extraParams)i.extraParams.hasOwnProperty(o)&&t.append(o,i.extraParams[o]);if(a.open("POST",i.uploadUrl),"object"==typeof i.extraHeaders)for(var l in i.extraHeaders)i.extraHeaders.hasOwnProperty(l)&&a.setRequestHeader(l,i.extraHeaders[l]);a.onload=function(){if(200===a.status||201===a.status){var e=JSON.parse(a.responseText);d.onUploadedFile(e)}else d.onErrorUploading()},a.send(t)},this.isAllowedFile=function(e){return i.allowedTypes.indexOf(e.type)>=0},this.onUploadedFile=function(e){var t,a=i.onUploadedFile(e);if(i.dataProcessor&&(e=i.dataProcessor(e)),t=e[i.downloadFieldName],a!==!1&&t){var n=l.getValue().replace(o,i.urlText.replace(s,t));l.setValue(n)}},this.customUploadHandler=function(e){return i.customUploadHandler(e)},this.onErrorUploading=function(){var e=l.getValue().replace(o,"");l.setValue(e),i.customErrorHandler()&&t.alert(i.errorText)},this.onReceivedFile=function(e){var t=i.onReceivedFile(e);t!==!1&&(o=i.progressText,l.setValue(r(l.getValue(),o)))},this.onPaste=function(e){var t,a=!1,n=e.clipboardData;if("object"==typeof n){t=n.items||n.files||[];for(var r=0;t.length>r;r++){var o=t[r];d.isAllowedFile(o)&&(a=!0,this.onReceivedFile(o.getAsFile()),this.customUploadHandler(o.getAsFile())&&this.uploadFile(o.getAsFile()))}}return a},this.onDrop=function(e){for(var t=!1,a=0;e.dataTransfer.files.length>a;a++){var n=e.dataTransfer.files[a];d.isAllowedFile(n)&&(t=!0,this.onReceivedFile(n),this.customUploadHandler(n)&&this.uploadFile(n))}return t}},t.inlineAttach.Editor=function(e){var t=e;return{getValue:function(){return t.value},setValue:function(e){t.value=e}}},t.inlineAttach.defaults={uploadUrl:"upload_attachment.php",uploadFieldName:"file",downloadFieldName:"filename",allowedTypes:["image/jpeg","image/png","image/jpg","image/gif"],progressText:"![Uploading file...]()",urlText:"![file]({filename})",errorText:"Error uploading file",extraParams:{},extraHeaders:{},onReceivedFile:function(){},customUploadHandler:function(){return!0},customErrorHandler:function(){return!0},onUploadedFile:function(){}},t.inlineAttach.attachToInput=function(e,t){t=t||{};var a=new inlineAttach.Editor(e),n=new inlineAttach(t,a);e.addEventListener("paste",function(e){n.onPaste(e)},!1),e.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault(),n.onDrop(e)},!1),e.addEventListener("dragenter",function(e){e.stopPropagation(),e.preventDefault()},!1),e.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault()},!1)}})(document,window);